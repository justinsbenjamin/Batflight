---
title: "Bat Flight Simulation"
author: "Justin Benjamin & Renata Soljmosi"
date: "April 4th, 2024"
output:
  ioslides_presentation: default
    #css: customCSS_ioslides.css #didn't work
  beamer_presentation: default
subtitle: Quantitative Methods in Ecology and Evolution

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load libraries
library(glmmTMB)
library(dplyr)
library(purrr)
library(broom.mixed)
library(tidyverse)

if (packageVersion("broom.mixed") < "0.2.9.5") {
    warning("please install the latest version of broom.mixed via remotes::install_github('bbolker/broom.mixed')")
}
```

## Introduction

- Big brown bats (*Eptesicus fuscus*)
- Captive colony at McMaster University
- Previously we found they weren't willing/able to fly in captivity
- Planning a new study to examine whether exercise via treadmill can help captive
bats become more willing and able to fly
- Don't have data yet as this is an upcoming study
- Our project aims to simulate and analyze data 

## Study design

- Repeated measures study with 30 bats measured every 3 days over 60 days

- **Predictor variables**
    - Day
    - Treatment (exercise or no exercise)

- **Response variables**
    - Mass (grams)
    - Flight time (s): flight ability
    - Number of "shakes" needed for bat to take off: flight willingness
    
## Hypothesis and predictions

- **Hypothesis:** Exercise improves bat flight ability/willingness
- **Specific Predictions:** 
    - Exercised bats will have longer flight times than non-exercised bats
    - Exercised bats will need less shakes to fly than non-exercised bats

## Simulation process
- Choose parameters
- Simulate data using these parameters and ensure they seem reasonable 
- Wrap in a function to repeat many times

## Simulation example (flight time)
### Set up to create a simulation function 
```{r, echo=TRUE}
set.seed(202)

n_per_group=15; days=seq(0, 60, by=3) 
n_groups <- 2
n_bats <- n_per_group*n_groups
```


## Simulation example continued
```{r, echo=TRUE}
form0 <- ~ 1 + day + treatment:day + (day | batID)
```
**1**: intercept; **day**: the effect of day on flight time; 

**treatment:day**: interaction (the effect of day on flight time varies depending on treatment level)

**(day | batID)**: random effects (allows for individual variability in the intercept and slope of the relationship between day and flight time among different bats)

## Simulation example continued
```{r, echo=TRUE}
β0=2; β_day=(0.5/60); β_daytreat=(2/60) 
corr_trans <- function(rho) rho/(sqrt(1+rho^2))
corr=corr_trans(-0.75)
sdint=0.5; sdslope=(0.5/60); sdres=0.1
```
**β0**: intercept; **β_day**: change in flight time for control; **β_daytreat**: *additional* change in flight time in treatment group

**corr**: correlation between intercepts and slopes. **rho** (-0.75) transformed with corr_trans

**sdint**: standard deviation of intercept; **sdslope**: standard deviation of slope; **sdres**: standard deviation of residual variance 

## Simulation example continued
```{r, echo=TRUE}
sim <- function(n_per_group, days, β0, β_day, β_daytreat
                , sdint, sdslope, corr, sdres, ...
){
  batID <- as.factor(1:n_bats) 
  treatment <- as.factor(rep(c("control", "exercise"), each=n_per_group)) 
  tdat <- data.frame(batID, treatment) 
  dat1 <- expand.grid(batID=batID, day=days) 
  flight_data <- full_join(dat1, tdat, by="batID") 
  flightTime <- simulate_new(form0, 
                            nsim = 1,
                            family = "gaussian", 
                            newdata = flight_data,
                            newparams = list(
                              beta = c(β0, β_day, β_daytreat) 
                              , theta = c(log(sdint), log(sdslope), corr) 
                              , betad = log(sdres)
                            )
  )
  
  flight_data$flightTime <- flightTime[[1]]
  return(flight_data) 
}
```
This creates a data simulation function


## Simulation example continued
### Simulate once and plot to ensure it looks reasonable
```{r, echo=TRUE}
s1 <- sim(n_per_group=n_per_group, days=days
          , β0=β0, β_day=β_day, β_daytreat=β_daytreat
          , sdint=sdint, sdslope=sdslope, corr=corr, sdres=sdres)
```
This applies our set parameters to simulate a data set


## Simulation example continued
```{r, echo=FALSE}
plot_sim <- function(flight_data) {
  ggplot(flight_data, aes(day, flightTime, colour = treatment)) +
    geom_line(aes(group=batID))
}
plot_sim(s1)
```


## Simulation example continued
### Wrap in a function to repeat many times
Our model:
```{r, echo=TRUE}
form1 <- flightTime ~ 1 + day + treatment:day + (day | batID)
```

```{r, echo=TRUE}
fit <- function(flight_data){
  return(glmmTMB(form1 
                 , data=flight_data
                 , family = "gaussian"
  ))
}
```
This creates a model fitting function


## Simulation example continued
```{r, echo=TRUE}
simCIs <- function(simfun, fitfun, ...){  
  dat <- simfun(...) 
  fit <- fitfun(dat) 
  tt <- (tidy(fit, effects = "fixed", conf.int = TRUE) 
         %>% select(term, est = estimate, lwr = conf.low, upr = conf.high) 
         %>% mutate(across(where(is.character), factor)) 
  )
  return(tt) 
}
```
This creates a function that simulates data, models it, and extracts the coefficients and their confidence intervals


## Simulation example continued
```{r, echo=TRUE}
nReps <- 1000
flightTime <- map_dfr(1:nReps, simCIs, .id="sim_flight" 
                 , .progress = interactive() 
                 , simfun=sim, fitfun=fit 
                 , n_per_group = n_per_group, days=days 
                 , β0=β0, β_day=β_day, β_daytreat=β_daytreat
                 , sdint=sdint, sdslope=sdslope, corr=corr, sdres=sdres
  )
```
This applies the simCI function from the previous slide iteratively to simulate data, model it, and extract the coefficients and confidence intervals 1000 times


## Simulation example continued
### Examine the data
```{r, echo=TRUE}
summary(flightTime)
```

## Simulation example continued
### Examine the data
```{r, echo=TRUE}
treatmentTrue_flightTime <- β_daytreat
```
This is the *simulated* (true) value of the parameter we're testing
```{r, echo=TRUE}
dt_flight <- (flightTime
              %>% filter(term=="day:treatmentexercise")
              %>% drop_na() 
)
```
This filters out the rows we are interested in: those where the value in the column term is day:treatmentexercise


## Simulation example continued
### Examine the data
```{r, echo=TRUE}
dt_flight %>% summarize(
  toohigh=mean(lwr>treatmentTrue_flightTime) 
  , toolow=mean(upr<treatmentTrue_flightTime) 
  , ci_width=mean(upr-lwr) 
  , power = mean(lwr>0) 
)
```
This extracts the relavant information regarding the confidence intervals



## Visualize the data
### Caterpillar plot
```{r, echo = FALSE}
dt_flight <- (dt_flight
    |> mutate(across(sim_flight, ~ reorder(factor(.), est)))
)
no_x_axis <- theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank())
gg1 <- ggplot(dt_flight, aes(sim_flight, est)) +
    geom_pointrange(aes(ymin = lwr, ymax = upr)) +
    ## blank x axis
    no_x_axis +
    ## reference line for coverage (do CIs include true value?)
    geom_hline(yintercept = β_daytreat,
               colour = "red", linewidth = 2) +
    ## reference line for power (do CIs include 0?)
    geom_hline(yintercept = 0,
               colour = "blue", linewidth = 2) + 
    expand_limits(x=0)
print(gg1)

```



##Simulated mass data
Very similar procedure because mass is also a continuous response variable.
Our model:
```{r, echo = TRUE}
form1_m <- mass ~ 1 + day + treatment:day + (day | batID)
```

##Simulated mass data
```{r, echo = FALSE}
β0m=30; β_daym=(-3/60); β_daytreatm=(-1.5/60)
form0m <- ~ 1 + day + treatment:day + (day | batID)
sdintm=5; sdslopem=(1/60); sdresm=0.5

sim2 <- function(n_per_group, days, β0m, β_daym, β_daytreatm
                , sdintm, sdslopem, corr, sdresm, ...
){
  batID <- as.factor(1:n_bats) #create individual bat IDs ## JD: Make this look less like a number with paste()
  treatment <- as.factor(rep(c("control", "exercise"), each=n_per_group)) #create treatment groups, 15 per group
  tdat <- data.frame(batID, treatment) #create data frame with batIDs and treatment groups
  dat1 <- expand.grid(batID=batID, day=days) #expand so each batID occurs for each day measured 
  bat_data <- full_join(dat1, tdat, by="batID") #combine to have batID, treatment groups, days
  mass_data <- simulate_new(form0m, #simulate mass data with gaussian distribution, using set parameters
                   nsim = 1,
                   family = "gaussian",
                   newdata = bat_data,
                   newparams = list(
                       beta = c(β0m, β_daym, β_daytreatm) 
                     , theta = c(log(sdintm), log(sdslopem), corr)
                     , betad = log(sdresm) 
      )
    )

     bat_data$mass <- mass_data[[1]] #assigns simulated mass data to a mass column in bat_data
     return(bat_data) # allows the modified bat_data object to be used or assigned to a variable outside of the function
}

s2 <- sim2(n_per_group=n_per_group, days=days
  , β0m=β0m, β_daym=β_daym, β_daytreatm=β_daytreatm
  , sdintm=sdintm, sdslopem=sdslopem, corr=corr, sdresm=sdresm)

plot_sim2 <- function(bat_data) {
    ggplot(bat_data, aes(day, mass, colour = treatment)) +
        geom_line(aes(group=batID))
}
plot_sim2(s2)
```

```{r, echo = FALSE}
mass <- readRDS("bat_mass_sims.RDS")
β_daytreat_mass=(-1.5/60)
treatmentTrue_mass <- β_daytreat_mass
```


##Simulated mass data
```{r, echo = TRUE}
summary(mass)
```

```{r, echo = FALSE}
dt_mass <- (mass
           %>% filter(term=="day:treatmentexercise") #retains only rows where the value in the column term is day:treatmentexercise
           %>% drop_na() #removes rows missing values
)
dt_mass %>% summarize(
                toohigh=mean(lwr>treatmentTrue_mass) #proportion of CIs where the lower bound is greater than treatmentTrue 
              , toolow=mean(upr<treatmentTrue_mass) #proportion of CIs where the upper bound is lower than treatmentTrue 
              , ci_width=mean(upr-lwr) #mean width of CIs
              , power = mean(upr<0) #proportion of CIs where the lower bound is greater than zero. We are only interested in “power” to detect the true effect direction
            )
```

##Simulated mass data
### Caterpillar plot
```{r, echo = FALSE}
dt_mass <- (dt_mass
    |> mutate(across(sim, ~ reorder(factor(.), est)))
)
no_x_axis <- theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank())

gg2 <- ggplot(dt_mass, aes(sim, est)) +
    geom_pointrange(aes(ymin = lwr, ymax = upr)) +
    ## blank x axis
    no_x_axis +
    ## reference line for coverage (do CIs include true value?)
    geom_hline(yintercept = β_daytreat_mass,
               colour = "red", linewidth = 2) +
    ## reference line for power (do CIs include 0?)
    geom_hline(yintercept = 0,
               colour = "blue", linewidth = 2) + 
    expand_limits(x=0)

print(gg2)
```



## Next steps

- Simulation with shakes as count data (Negative binomial or Poisson models)
- Mass as a predictor variable?
- Analyses

## Questions?
